<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to Markdown</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 16px;
        }
        .container {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 680px;
            padding: 32px;
        }
        h1 { font-size: 22px; margin-bottom: 24px; text-align: center; }

        /* tabs */
        .tabs { display: flex; border-bottom: 2px solid #e0e0e0; margin-bottom: 20px; }
        .tab-btn {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            border: none; background: none; font-size: 15px; font-weight: 600;
            color: #888; border-bottom: 2px solid transparent; margin-bottom: -2px;
            transition: color .2s, border-color .2s;
        }
        .tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* drop zone */
        .drop-zone {
            border: 2px dashed #d0d0d0;
            border-radius: 10px;
            padding: 32px 16px;
            text-align: center;
            cursor: pointer;
            transition: border-color .2s, background .2s;
            margin-bottom: 14px;
        }
        .drop-zone:hover, .drop-zone.drag-over {
            border-color: #2563eb;
            background: #eff6ff;
        }
        .drop-zone-text { font-size: 14px; color: #888; }
        .drop-zone-text strong { color: #2563eb; }
        .drop-zone-file { font-size: 14px; color: #333; font-weight: 600; margin-top: 8px; }
        .drop-zone input[type="file"] { display: none; }

        /* form */
        .field { margin-bottom: 14px; }
        .field label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 4px; color: #555; }
        .field input[type="text"] {
            width: 100%; padding: 9px 12px; border: 1px solid #d0d0d0;
            border-radius: 6px; font-size: 14px; outline: none; transition: border-color .2s;
        }
        .field input[type="text"]:focus { border-color: #2563eb; }
        .checkbox-group { display: flex; gap: 20px; margin-top: 4px; }
        .checkbox-group label {
            font-size: 14px; font-weight: normal;
            display: flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .hint { font-size: 12px; color: #999; }

        /* button */
        .convert-btn {
            display: block; width: 100%; padding: 12px; background: #2563eb; color: #fff;
            border: none; border-radius: 8px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 8px; transition: background .2s;
        }
        .convert-btn:hover { background: #1d4ed8; }
        .convert-btn:disabled { background: #93b4f5; cursor: not-allowed; }

        .download-btn {
            display: none; width: 100%; padding: 10px; margin-top: 8px;
            background: #16a34a; color: #fff; border: none; border-radius: 8px;
            font-size: 15px; font-weight: 600; cursor: pointer; transition: background .2s;
        }
        .download-btn:hover { background: #15803d; }

        /* progress */
        .progress-section { margin-top: 24px; }
        .progress-bar-bg { width: 100%; height: 10px; background: #e5e7eb; border-radius: 5px; overflow: hidden; }
        .progress-bar-fill { height: 100%; width: 0%; background: #2563eb; border-radius: 5px; transition: width .3s; }
        .status-text { font-size: 13px; color: #666; margin-top: 6px; }

        /* log */
        .log-section { margin-top: 20px; }
        .log-section h3 { font-size: 14px; margin-bottom: 6px; color: #555; }
        .log-box {
            background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px;
            padding: 12px; height: 200px; overflow-y: auto;
            font-family: 'Consolas', 'D2Coding', monospace; font-size: 13px;
            line-height: 1.6; white-space: pre-wrap;
        }
        .log-success { color: #16a34a; }
        .log-fail { color: #dc2626; }
        .log-info { color: #555; }
    </style>
</head>
<body>
    <div class="container">
        <h1>PDF to Markdown</h1>

        <div class="tabs">
            <button class="tab-btn active" data-tab="single">PDF 파일 변환</button>
            <button class="tab-btn" data-tab="batch">폴더 일괄 변환</button>
        </div>

        <!-- 탭 1: 단일 파일 (드래그 앤 드롭 업로드) -->
        <div id="tab-single" class="tab-panel active">
            <div class="drop-zone" id="drop-zone">
                <input type="file" id="file-input" accept=".pdf">
                <div class="drop-zone-text">
                    PDF 파일을 여기에 <strong>드래그</strong>하거나 <strong>클릭</strong>하여 선택하세요
                </div>
                <div class="drop-zone-file" id="drop-zone-file"></div>
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="single-images" checked> 이미지 추출</label>
            </div>
        </div>

        <!-- 탭 2: 폴더 일괄 (경로 입력) -->
        <div id="tab-batch" class="tab-panel">
            <div class="field">
                <label>입력 폴더 경로</label>
                <input type="text" id="input-dir" placeholder="예: C:\PDFs">
            </div>
            <div class="field">
                <label>출력 폴더 <span class="hint">(비워두면 입력과 같은 위치)</span></label>
                <input type="text" id="batch-output" placeholder="예: C:\Output">
            </div>
            <div class="checkbox-group">
                <label><input type="checkbox" id="batch-images" checked> 이미지 추출</label>
                <label><input type="checkbox" id="recursive"> 하위 폴더 포함</label>
            </div>
        </div>

        <button class="convert-btn" id="convert-btn">변환 시작</button>
        <button class="download-btn" id="download-btn">결과 다운로드 (.md)</button>

        <div class="progress-section">
            <div class="progress-bar-bg">
                <div class="progress-bar-fill" id="progress-fill"></div>
            </div>
            <div class="status-text" id="status-text">대기 중</div>
        </div>

        <div class="log-section">
            <h3>로그</h3>
            <div class="log-box" id="log-box"></div>
        </div>
    </div>

    <script>
        // --- 탭 ---
        let currentTab = 'single';
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                btn.classList.add('active');
                currentTab = btn.dataset.tab;
                document.getElementById('tab-' + currentTab).classList.add('active');
            });
        });

        // --- 드래그 앤 드롭 ---
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const dropZoneFile = document.getElementById('drop-zone-file');
        let selectedFile = null;

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0 && files[0].name.toLowerCase().endsWith('.pdf')) {
                selectedFile = files[0];
                dropZoneFile.textContent = selectedFile.name;
            } else {
                dropZoneFile.textContent = 'PDF 파일만 선택 가능합니다.';
            }
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                selectedFile = fileInput.files[0];
                dropZoneFile.textContent = selectedFile.name;
            }
        });

        // 페이지 전체 드래그 방지
        document.addEventListener('dragover', e => e.preventDefault());
        document.addEventListener('drop', e => e.preventDefault());

        // --- 변환 ---
        const convertBtn = document.getElementById('convert-btn');
        const downloadBtn = document.getElementById('download-btn');
        const progressFill = document.getElementById('progress-fill');
        const statusText = document.getElementById('status-text');
        const logBox = document.getElementById('log-box');
        let polling = null;
        let lastLogCount = 0;

        convertBtn.addEventListener('click', async () => {
            logBox.innerHTML = '';
            lastLogCount = 0;
            progressFill.style.width = '0%';
            downloadBtn.style.display = 'none';

            if (currentTab === 'single') {
                await startUploadConvert();
            } else {
                await startBatchConvert();
            }
        });

        async function startUploadConvert() {
            if (!selectedFile) {
                appendLog('[오류] PDF 파일을 선택해주세요.', 'fail');
                return;
            }
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('save_images', document.getElementById('single-images').checked);

            try {
                const res = await fetch('/upload', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.error) { appendLog(data.error, 'fail'); return; }
                convertBtn.disabled = true;
                startPolling(true);
            } catch (e) {
                appendLog('[오류] 서버 연결 실패', 'fail');
            }
        }

        async function startBatchConvert() {
            const body = {
                mode: 'batch',
                input_dir: document.getElementById('input-dir').value,
                output_dir: document.getElementById('batch-output').value,
                save_images: document.getElementById('batch-images').checked,
                recursive: document.getElementById('recursive').checked,
            };
            try {
                const res = await fetch('/convert', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body),
                });
                const data = await res.json();
                if (data.error) { appendLog(data.error, 'fail'); return; }
                convertBtn.disabled = true;
                startPolling(false);
            } catch (e) {
                appendLog('[오류] 서버 연결 실패', 'fail');
            }
        }

        function startPolling(showDownload) {
            polling = setInterval(async () => {
                try {
                    const res = await fetch('/status');
                    const data = await res.json();
                    progressFill.style.width = data.progress + '%';
                    statusText.textContent = data.status;

                    for (let i = lastLogCount; i < data.logs.length; i++) {
                        const msg = data.logs[i];
                        let cls = 'info';
                        if (msg.startsWith('[성공]')) cls = 'success';
                        else if (msg.startsWith('[실패]') || msg.startsWith('[오류]')) cls = 'fail';
                        appendLog(msg, cls);
                    }
                    lastLogCount = data.logs.length;

                    if (!data.running) {
                        clearInterval(polling);
                        convertBtn.disabled = false;
                        if (showDownload && data.result_path) {
                            downloadBtn.style.display = 'block';
                        }
                    }
                } catch (e) {
                    clearInterval(polling);
                    convertBtn.disabled = false;
                }
            }, 2000);
        }

        downloadBtn.addEventListener('click', () => {
            window.location.href = '/download';
        });

        function appendLog(msg, type) {
            const span = document.createElement('span');
            span.className = 'log-' + type;
            span.textContent = msg + '\n';
            logBox.appendChild(span);
            logBox.scrollTop = logBox.scrollHeight;
        }
    </script>
</body>
</html>
